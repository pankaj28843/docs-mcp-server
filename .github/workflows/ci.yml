name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  test:
    name: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Install Playwright browsers
        run: uv run playwright install chromium --with-deps

      - name: Ruff format (check)
        run: uv run ruff format . --check

      - name: Ruff lint
        run: uv run ruff check .

      - name: Unit tests
        run: timeout 60 uv run pytest -m unit

      - name: MCP Tools Integration Test
        run: |
          echo "ðŸš€ Testing MCP tools functionality..."
          timeout 120 uv run python integration_tests/ci_mcp_test.py

      - name: Report coverage
        if: always()
        run: |
          python - <<'PY'
          import os
          import sys
          import xml.etree.ElementTree as ET

          report_path = "coverage.xml"
          minimum = 95.0

          if not os.path.exists(report_path):
              print("::error title=Coverage report missing::coverage.xml not found")
              sys.exit(0)

          root = ET.parse(report_path).getroot()
          line_rate = float(root.get("line-rate", "0") or 0)
          line_pct = round(line_rate * 100, 2)

          summary = [
              "## Coverage",
              f"Line coverage: {line_pct:.2f}%",
              f"Minimum required: {minimum:.2f}%",
              "",
          ]

          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary_path:
              with open(summary_path, "a", encoding="utf-8") as handle:
                  handle.write("\n".join(summary))

          if line_pct < minimum:
              print(f"::error title=Coverage below {minimum:.0f}%::Line coverage {line_pct:.2f}%")
              sys.exit(1)
          PY

  build-and-push:
    name: Build and push (GHCR)
    needs: test
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      attestations: write
      id-token: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,format=short,enable={{is_default_branch}}
            type=ref,event=tag

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: push
        uses: docker/build-push-action@f2a1d5e99d037542a71f64918e516c093c6f3fc4
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@v0.17.3
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}
          format: cyclonedx-json
          output-file: sbom.cdx.json
          upload-artifact: true

      - name: Vulnerability scan (grype)
        uses: anchore/scan-action@v3.4.0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.push.outputs.digest }}
          output-format: sarif
          output-file: grype-report.sarif
          severity-cutoff: medium
          fail-build: false

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: grype-report
          path: grype-report.sarif
          retention-days: 7

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

      - name: Upload SBOM to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: sbom.cdx.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

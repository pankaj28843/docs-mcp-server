<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Docs MCP Dashboard - {{ tenant_codename }}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100">
    <div class="max-w-none mx-auto px-6 py-8">
      <header class="flex flex-wrap items-center justify-between gap-4 mb-8">
        <div>
          <p class="text-xs uppercase tracking-widest text-slate-400">Docs MCP</p>
          <h1 class="text-3xl font-semibold">Tenant: {{ tenant_codename }}</h1>
          <p class="text-sm text-slate-400">Last refresh: <span id="last-refresh">n/a</span></p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <a href="/dashboard" class="text-sm text-cyan-300 hover:text-cyan-200">Back to dashboard</a>
          <button id="trigger-sync" class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold px-3 py-2 rounded text-sm">
            Trigger sync
          </button>
          <button id="force-sync" class="bg-amber-400 hover:bg-amber-300 text-slate-900 font-semibold px-3 py-2 rounded text-sm">
            Force sync
          </button>
          <button id="refresh-now" class="bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-semibold px-4 py-2 rounded text-sm">
            Refresh
          </button>
        </div>
      </header>

      <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <p class="text-xs text-slate-400 uppercase">Queue</p>
          <p id="metric-queue" class="text-2xl font-semibold">n/a</p>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <p class="text-xs text-slate-400 uppercase">Success</p>
          <p id="metric-success" class="text-2xl font-semibold">n/a</p>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <p class="text-xs text-slate-400 uppercase">Failures</p>
          <p id="metric-fail" class="text-2xl font-semibold">n/a</p>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <p class="text-xs text-slate-400 uppercase">Tracked URLs</p>
          <p id="metric-total" class="text-2xl font-semibold">n/a</p>
        </div>
      </section>

      <section class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
        <div class="xl:col-span-2 bg-slate-900 border border-slate-800 rounded-xl p-4">
          <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
            <h2 class="text-sm uppercase tracking-widest text-slate-400">Event History</h2>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <label class="text-xs uppercase tracking-widest text-slate-400" for="range-select">Range</label>
                <select id="range-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs">
                  <option value="7">7d</option>
                  <option value="14">14d</option>
                  <option value="49" selected>7w</option>
                </select>
              </div>
              <label class="text-xs uppercase tracking-widest text-slate-400" for="bucket-select">Bucket</label>
              <select id="bucket-select" class="bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs">
                <option value="60">1h</option>
                <option value="180">3h</option>
                <option value="360" selected>6h</option>
                <option value="720">12h</option>
                <option value="1440">24h</option>
              </select>
            </div>
          </div>
          <canvas id="historyChart" height="160"></canvas>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4">
            <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
              <p class="text-xs text-slate-400 uppercase">Events</p>
              <p id="events-total" class="text-lg font-semibold">n/a</p>
            </div>
            <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
              <p class="text-xs text-slate-400 uppercase">Errors</p>
              <p id="events-failed" class="text-lg font-semibold">n/a</p>
            </div>
            <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
              <p class="text-xs text-slate-400 uppercase">Fetched</p>
              <p id="events-fetched" class="text-lg font-semibold">n/a</p>
            </div>
            <div class="bg-slate-950 border border-slate-800 rounded-lg p-3">
              <p class="text-xs text-slate-400 uppercase">Discovered</p>
              <p id="events-discovered" class="text-lg font-semibold">n/a</p>
            </div>
          </div>
        </div>
        <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
          <h2 class="text-sm uppercase tracking-widest text-slate-400 mb-3">Recent Status Payload</h2>
          <pre class="text-xs bg-slate-950 border border-slate-800 rounded-lg p-3 overflow-auto max-h-96 max-w-none"><code class="language-json" id="status-json">{}</code></pre>
        </div>
      </section>

      <section class="bg-slate-900 border border-slate-800 rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
          <h2 class="text-sm uppercase tracking-widest text-slate-400">Event Logs</h2>
          <div class="flex flex-wrap gap-2">
            <button class="tab-button bg-slate-800 text-slate-100 px-3 py-1 rounded text-xs" data-tab="all">All</button>
            <button class="tab-button bg-slate-800 text-slate-100 px-3 py-1 rounded text-xs" data-tab="errors">Errors</button>
            <button class="tab-button bg-slate-800 text-slate-100 px-3 py-1 rounded text-xs" data-tab="fetch">Fetch</button>
            <button class="tab-button bg-slate-800 text-slate-100 px-3 py-1 rounded text-xs" data-tab="discover">Discover</button>
            <button class="tab-button bg-slate-800 text-slate-100 px-3 py-1 rounded text-xs" data-tab="skip">Skip</button>
          </div>
        </div>
        <div id="event-log" class="space-y-2 text-xs"></div>
      </section>

      <footer class="text-xs text-slate-500">Powered by /{{ tenant_codename }}/sync/status and /dashboard/{{ tenant_codename }}/events</footer>
    </div>

    <script>
      const TENANT = "{{ tenant_codename }}";
      const statusUrl = `/${TENANT}/sync/status`;
      const triggerUrl = (force) => `/${TENANT}/sync/trigger?force_crawler=${force}&force_full_sync=${force}`;
      const logsUrl = (params) => `/dashboard/${TENANT}/events/logs?${params.toString()}`;

      const byId = (id) => document.getElementById(id);
      const fmt = (value) => (Number.isFinite(value) ? value.toLocaleString() : "n/a");
      const parseNumber = (value) => (Number.isFinite(Number(value)) ? Number(value) : 0);

      let historyChart;
      const urlParams = new URLSearchParams(window.location.search);
      const defaultRangeDays = urlParams.get("range_days") || "49";
      const defaultBucket = urlParams.get("bucket") || "360";
      const defaultTab = urlParams.get("tab") || "all";
      let currentTab = defaultTab;

      function initChart() {
        const ctx = byId("historyChart").getContext("2d");
        historyChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              { label: "Total", data: [], borderColor: "#38bdf8", tension: 0.25 },
              { label: "Success", data: [], borderColor: "#22d3ee", tension: 0.25 },
              { label: "Failed", data: [], borderColor: "#f43f5e", tension: 0.25 },
              { label: "Discovered", data: [], borderColor: "#a855f7", tension: 0.25 },
              { label: "Fetched", data: [], borderColor: "#f59e0b", tension: 0.25 },
            ],
          },
          options: {
            plugins: { legend: { labels: { color: "#cbd5f5" } } },
            scales: {
              x: { ticks: { color: "#94a3b8" } },
              y: { ticks: { color: "#94a3b8" } },
            },
          },
        });
      }

      function updateLastRefresh() {
        byId("last-refresh").textContent = new Date().toLocaleTimeString();
      }

      function updateStatus(payload) {
        const stats = payload.stats || {};
        const queue = parseNumber(stats.queue_depth ?? 0);
        const ok = parseNumber(stats.metadata_successful ?? 0);
        const fail = parseNumber(stats.failed_url_count ?? 0);
        const total = parseNumber(stats.metadata_total_urls ?? 0);

        byId("metric-queue").textContent = fmt(queue);
        byId("metric-success").textContent = fmt(ok);
        byId("metric-fail").textContent = fmt(fail);
        byId("metric-total").textContent = fmt(total);

        const jsonEl = byId("status-json");
        jsonEl.textContent = JSON.stringify(payload, null, 2);
        if (window.Prism) {
          Prism.highlightElement(jsonEl);
        }
      }

      function updateHistory(payload) {
        const buckets = payload.buckets || [];
        historyChart.data.labels = buckets.map((bucket) => bucket.t);
        historyChart.data.datasets[0].data = buckets.map((bucket) => bucket.total || 0);
        historyChart.data.datasets[1].data = buckets.map((bucket) => bucket.success || 0);
        historyChart.data.datasets[2].data = buckets.map((bucket) => bucket.failed || 0);
        historyChart.data.datasets[3].data = buckets.map((bucket) => bucket.discovered || 0);
        historyChart.data.datasets[4].data = buckets.map((bucket) => bucket.fetched || 0);
        historyChart.update();

        const statusCounts = payload.status_counts || {};
        const typeCounts = payload.type_counts || {};
        byId("events-total").textContent = fmt(payload.total_events || 0);
        byId("events-failed").textContent = fmt(statusCounts.failed || 0);
        byId("events-fetched").textContent = fmt(typeCounts.fetch_success || 0);
        byId("events-discovered").textContent = fmt(typeCounts.crawl_discovered || 0);
      }

      async function fetchStatus() {
        try {
          const res = await fetch(statusUrl, { cache: "no-store" });
          if (!res.ok) throw new Error(`Status ${res.status}`);
          const data = await res.json();
          updateStatus(data);
          updateLastRefresh();
        } catch (err) {
          console.warn("Failed to fetch status", err);
        }
      }

      async function fetchHistory() {
        try {
          const bucketMinutes = byId("bucket-select").value;
          const rangeDays = byId("range-select").value;
          const url = `/dashboard/${TENANT}/events?range_days=${rangeDays}&bucket_minutes=${bucketMinutes}`;
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) throw new Error(`History ${res.status}`);
          const data = await res.json();
          updateHistory(data);
        } catch (err) {
          console.warn("Failed to fetch history", err);
        }
      }

      function updateUrlParam(key, value) {
        if (value) {
          urlParams.set(key, value);
        } else {
          urlParams.delete(key);
        }
        const query = urlParams.toString();
        const next = query ? `?${query}` : window.location.pathname;
        window.history.replaceState({}, "", next);
      }

      async function fetchEventLogs(tab) {
        const params = new URLSearchParams();
        if (tab === "errors") {
          params.set("status", "failed");
        } else if (tab === "fetch") {
          params.set("event_type", "fetch_success");
        } else if (tab === "discover") {
          params.set("event_type", "crawl_discovered");
        } else if (tab === "skip") {
          params.set("event_type", "skip_recent");
        }
        params.set("limit", "200");
        try {
          const res = await fetch(logsUrl(params), { cache: "no-store" });
          if (!res.ok) throw new Error(`Logs ${res.status}`);
          const data = await res.json();
          renderEventLogs(data.events || []);
        } catch (err) {
          console.warn("Failed to fetch logs", err);
        }
      }

      function renderEventLogs(events) {
        const container = byId("event-log");
        container.innerHTML = "";
        if (!events.length) {
          container.innerHTML = "<p class=\"text-slate-400\">No events in this range.</p>";
          return;
        }
        events.forEach((event) => {
          const row = document.createElement("div");
          row.className = "bg-slate-950 border border-slate-800 rounded-lg p-3";
          row.innerHTML = `
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div class="text-slate-200 font-semibold">${event.event_type}</div>
              <div class="text-slate-400">${event.event_at || "n/a"}</div>
            </div>
            <div class="text-slate-400 mt-1">${event.status || ""} ${event.reason ? `â€¢ ${event.reason}` : ""}</div>
            <div class="text-slate-500 mt-1 break-all">${event.url || ""}</div>
          `;
          container.appendChild(row);
        });
      }

      function setActiveTab(tab) {
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("bg-cyan-500", "text-slate-900");
          btn.classList.add("bg-slate-800", "text-slate-100");
        });
        const active = document.querySelector(`.tab-button[data-tab="${tab}"]`);
        if (active) {
          active.classList.remove("bg-slate-800", "text-slate-100");
          active.classList.add("bg-cyan-500", "text-slate-900");
        }
      }

      byId("refresh-now").addEventListener("click", () => {
        fetchStatus();
        fetchHistory();
      });

      byId("bucket-select").addEventListener("change", () => {
        updateUrlParam("bucket", byId("bucket-select").value);
        fetchHistory();
      });

      byId("range-select").addEventListener("change", () => {
        updateUrlParam("range_days", byId("range-select").value);
        fetchHistory();
      });

      async function triggerSync(force) {
        try {
          const res = await fetch(triggerUrl(force), { method: "POST" });
          if (!res.ok) throw new Error(`Trigger failed ${res.status}`);
          const data = await res.json();
          alert(data.message || "Sync triggered");
        } catch (err) {
          console.warn("Failed to trigger sync", err);
          alert("Failed to trigger sync");
        }
      }

      byId("trigger-sync").addEventListener("click", () => triggerSync(false));
      byId("force-sync").addEventListener("click", () => triggerSync(true));

      byId("bucket-select").value = defaultBucket;
      byId("range-select").value = defaultRangeDays;

      document.querySelectorAll(".tab-button").forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.dataset.tab;
          currentTab = tab;
          updateUrlParam("tab", tab);
          fetchEventLogs(tab);
          setActiveTab(tab);
        });
      });

      initChart();
      fetchStatus();
      fetchHistory();
      fetchEventLogs(defaultTab);
      setActiveTab(defaultTab);
      updateUrlParam("bucket", defaultBucket);
      updateUrlParam("range_days", defaultRangeDays);
      updateUrlParam("tab", defaultTab);
      setInterval(fetchStatus, 7000);
      setInterval(fetchHistory, 60000);
      setInterval(() => fetchEventLogs(currentTab), 10000);
    </script>
  </body>
</html>
